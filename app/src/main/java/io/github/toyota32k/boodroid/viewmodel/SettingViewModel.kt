package io.github.toyota32k.boodroid.viewmodel

import android.content.Context
import androidx.annotation.StringRes
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import io.github.toyota32k.binder.command.Command
import io.github.toyota32k.binder.list.ObservableList
import io.github.toyota32k.boodroid.BooApplication
import io.github.toyota32k.boodroid.R
import io.github.toyota32k.boodroid.common.PackageUtil
import io.github.toyota32k.boodroid.common.UtImmortalTaskContextSource
import io.github.toyota32k.boodroid.data.*
import io.github.toyota32k.boodroid.dialog.HostAddressDialog
import io.github.toyota32k.dialog.IUtDialog
import io.github.toyota32k.dialog.task.*
import io.github.toyota32k.ytremote.data.CategoryList
import kotlinx.coroutines.launch

//class RatingRadioGroup : RadioButtonGroup<Rating>() {
//    override fun id2value(id: Int): Rating? {
//        return Rating.values().find {it.id==id}
//    }
//    override fun value2id(v: Rating): Int {
//        return v.id
//    }
//
//    var rating:Rating?
//        get() = selected
//        set(v) { selected = v }
//}
//
//class MarkToggleGroup : ToggleButtonGroup<Mark>() {
//    override fun id2value(id: Int): Mark? {
//        return Mark.values().find { it.id == id }
//    }
//
//    override fun value2id(v: Mark): Int {
//        return v.id
//    }
//
//    var marks:List<Mark>
//        get() = selected
//        set(v) { selected = v }
//}
//
//class SourceTypeRadioGroup : RawRadioButtonGroup<SourceType>() {
//    override fun id2value(id: Int): SourceType? {
//        return SourceType.values().find {it.id ==id}
//    }
//
//    override fun value2id(v: SourceType): Int {
//        return v.id
//    }
//
//    var sourceType:SourceType?
//        get() = selected
//        set(v) {selected = v}
//}

class SettingViewModel : ViewModel(), IUtImmortalTaskMutableContextSource by UtImmortalTaskContextSource() {
    val activeHost = MutableLiveData<HostAddressEntity?>()
//    val editingHost = MutableLiveData<String>()
    val hostList = ObservableList<HostAddressEntity>()
    val hostCount = MutableLiveData<Int>(0)
//    val sourceType = MutableLiveD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ata<SourceType>()

    val sourceType = MutableLiveData(SourceType.DB)
    val rating = MutableLiveData(Rating.NORMAL)
    val theme = MutableLiveData(ThemeSetting.SYSTEM)
    val colorVariation = MutableLiveData(ColorVariation.PINK)
    val markList = MutableLiveData<List<Mark>>(emptyList())
    val showTitleOnScreen = MutableLiveData<Boolean>(false)
    val commandAddToList = Command()
    val commandCategory = Command()
    val categoryList = CategoryList().apply { update() }
    lateinit var version : String
    val context:Context get() = BooApplication.instance.applicationContext
    val originalSettings: Settings by lazy { Settings.load(context) }

    var prepared: Boolean = false
    fun prepare(): SettingViewModel {
        if (!prepared) {
            prepared = true
            load()
            version = "${PackageUtil.appName(context)} v${PackageUtil.getVersion(context)}"
        }
        return this
    }

    var result:Boolean = false
    val commandComplete = Command()

    init {
        hostList.addListenerForever {
            if(hostCount.value != it.list.size) {
                hostCount.value = it.list.size
            }
        }
    }

//    val category = categoryList.currentLabel


//    var srcTypeButton:MutableLiveData<Int>
//        get() = sourceType.map { it.id }
//        set(v) {
//            sourceType.value = SourceType.values().find {it.id==v}
//        }

//    fun hasHost(entity: HostAddressEntity): Boolean {
//        return null != hostList.find { it.address == entity.address }
//    }

//    fun addHost() {
//        viewModelScope.launch {
//            HostAddressDialog.getHostAddress()
//        }
//        addHost(address = editingHost.value ?: return)
//    }

    private fun addHost(entity: HostAddressEntity) {
        if(entity.address.isBlank()) return
        val org = hostList.find { it.address == entity.address }
        if(org!=null) {
            if(entity.name.isBlank() || entity.name == org.name) return
            hostList.remove(org)
        }
        hostList.add(entity)
        activeHost.value = entity
    }

    fun addHost() {
        viewModelScope.launch {
            val v = HostAddressDialog.getHostAddress(activeHost.value)
            if(v!=null && v.address.isNotBlank()) {
                addHost(v)
            }
        }
    }

    fun removeHost(entity: HostAddressEntity) {
        viewModelScope.launch {
            if(confirm(R.string.confirm_remove_host)) {
                val activeHostIndex = hostList.indexOf(activeHost.value)
                val index = hostList.indexOfFirst { it.address == entity.address }
                if(index>=0) {
                    hostList.removeAt(index)
                    if(index == activeHostIndex) {
                        activeHost.value = hostList.firstOrNull()
                    }
                }
            }
        }
    }

    fun editHost(entity: HostAddressEntity) {
        viewModelScope.launch {
            val v = HostAddressDialog.getHostAddress(entity)
            if(v!=null && entity!=v &&  v.address.isNotBlank()) {
                hostList.remove(entity)
                hostList.add(v)
                if(activeHost.value == null || activeHost.value==entity) {
                    activeHost.value = v
                }
            }
        }
    }

    fun checkOnClosing(done:Boolean) {
        immortalCoroutineScope.launch {
//            val editingHost = editingHost.value
//            val hostList = hostList
//            if (!editingHost.isNullOrBlank() && !hasHost(editingHost)) {
//                if (!confirm(R.string.confirm_close_on_editing_host)) {
//                    return@launch
//                }
//            }
            if (done && hostList.isEmpty()) {
                if (!confirm(R.string.confirm_close_with_no_host)) {
                    return@launch
                }
            }
            if(done) {
                save()
                AppViewModel.instance.settings = settings
            }

            result = done
            commandComplete.invoke()
        }
    }

    val settings: Settings
        get() = Settings(originalSettings,
            activeHostIndex = hostList.indexOfFirst { it.address == activeHost.value?.address },
            hostList = hostList,
            sourceType = sourceType.value ?: SourceType.DB,
            rating = rating.value ?: Rating.NORMAL,
            theme = theme.value ?: ThemeSetting.SYSTEM,
            colorVariation = colorVariation.value ?: ColorVariation.PINK,
            marks = markList.value ?: emptyList(),
            category = categoryList.category,
            showTitleOnScreen = showTitleOnScreen.value ?: false,
        )

    fun load() {
        val s = originalSettings
        activeHost.value = if(0<=s.activeHostIndex && s.activeHostIndex<s.hostList.size) s.hostList[s.activeHostIndex] else null
        hostList.replace(s.hostList)
        sourceType.value = s.sourceType
        rating.value = s.rating
        theme.value = s.theme
        colorVariation.value = s.colorVariation
        markList.value = s.marks
        categoryList.category = s.category
        showTitleOnScreen.value = s.showTitleOnScreen
    }

    fun save(): Boolean {
        val s = settings
        s.save(context)
        return true
    }

    companion object {
//        fun instanceFor(activity: ViewModelStoreOwner):SettingViewModel {
//            return ViewModelProvider(activity, ViewModelProvider.NewInstanceFactory()).get(SettingViewModel::class.java)
//        }
        /**
         * 
         */
        fun createBy(task: IUtImmortalTask, initialize: ((SettingViewModel) -> Unit)? = null): SettingViewModel
            = UtImmortalViewModelHelper.createBy(SettingViewModel::class.java, task, initialize)

        /**
         * 
         */
        fun instanceFor(dialog: IUtDialog): SettingViewModel
            = UtImmortalViewModelHelper.instanceFor(SettingViewModel::class.java, dialog)

        fun getString(@StringRes id:Int):String =
            BooApplication.instance.getString(id)

        suspend fun confirm(@StringRes id:Int):Boolean {
            return UtImmortalSimpleTask.runAsync("confirm") {
                showOkCancelMessageBox(getString(R.string.app_name), getString(id))
            }
        }

    }
}
