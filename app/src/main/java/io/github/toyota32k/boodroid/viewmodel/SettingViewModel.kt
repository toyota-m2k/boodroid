package io.github.toyota32k.boodroid.viewmodel

import android.content.Context
import androidx.annotation.StringRes
import androidx.lifecycle.MutableLiveData
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import io.github.toyota32k.bindit.Command
import io.github.toyota32k.bindit.list.ObservableList
import io.github.toyota32k.boodroid.BooApplication
import io.github.toyota32k.boodroid.R
import io.github.toyota32k.boodroid.common.PackageUtil
import io.github.toyota32k.boodroid.common.UtImmortalTaskContextSource
import io.github.toyota32k.boodroid.data.*
import io.github.toyota32k.dialog.IUtDialog
import io.github.toyota32k.dialog.task.*
import io.github.toyota32k.ytremote.data.CategoryList
import kotlinx.coroutines.launch

//class RatingRadioGroup : RadioButtonGroup<Rating>() {
//    override fun id2value(id: Int): Rating? {
//        return Rating.values().find {it.id==id}
//    }
//    override fun value2id(v: Rating): Int {
//        return v.id
//    }
//
//    var rating:Rating?
//        get() = selected
//        set(v) { selected = v }
//}
//
//class MarkToggleGroup : ToggleButtonGroup<Mark>() {
//    override fun id2value(id: Int): Mark? {
//        return Mark.values().find { it.id == id }
//    }
//
//    override fun value2id(v: Mark): Int {
//        return v.id
//    }
//
//    var marks:List<Mark>
//        get() = selected
//        set(v) { selected = v }
//}
//
//class SourceTypeRadioGroup : RawRadioButtonGroup<SourceType>() {
//    override fun id2value(id: Int): SourceType? {
//        return SourceType.values().find {it.id ==id}
//    }
//
//    override fun value2id(v: SourceType): Int {
//        return v.id
//    }
//
//    var sourceType:SourceType?
//        get() = selected
//        set(v) {selected = v}
//}

class SettingViewModel : ViewModel(), IUtImmortalTaskMutableContextSource by UtImmortalTaskContextSource() {
    val activeHost = MutableLiveData<String?>()
    val editingHost = MutableLiveData<String>()
    val hostList = ObservableList<String>()
    val hostCount = MutableLiveData<Int>(0)
//    val sourceType = MutableLiveD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ata<SourceType>()

    val sourceType = MutableLiveData(SourceType.DB)
    val rating = MutableLiveData(Rating.NORMAL)
    val theme = MutableLiveData(ThemeSetting.SYSTEM)
    val colorVariation = MutableLiveData(ColorVariation.PINK)
    val markList = MutableLiveData<List<Mark>>(emptyList())
    val commandAddToList = Command()
    val commandCategory = Command()
    val categoryList = CategoryList().apply { update() }
    lateinit var version : String

    var prepared: Boolean = false
    fun prepare(context: Context): SettingViewModel {
        if (!prepared) {
            prepared = true
            load(context)
            version = "${PackageUtil.appName(context)} v${PackageUtil.getVersion(context)}"
        }
        return this
    }

    var result:Boolean = false
    val commandComplete = Command()

    init {
        hostList.addListenerForever {
            if(hostCount.value != it.list.size) {
                hostCount.value = it.list.size
            }
        }
    }

//    val category = categoryList.currentLabel


//    var srcTypeButton:MutableLiveData<Int>
//        get() = sourceType.map { it.id }
//        set(v) {
//            sourceType.value = SourceType.values().find {it.id==v}
//        }

    fun hasHost(address: String): Boolean {
        return null != hostList.find { it == address }
    }

    fun addHost() {
        addHost(address = editingHost.value ?: return)
    }

    private fun addHost(address: String) {
        if (address.isNotBlank() && !hasHost(address)) {
            hostList.add(address)
            activeHost.value = address
        }
    }

    fun removeHost(address: String) {
        viewModelScope.launch {
            if(confirm(R.string.confirm_remove_host)) {
                hostList.remove(address)
                if (activeHost.value == address) {
                    activeHost.value = hostList.firstOrNull()
                }
            }
        }
    }

    fun checkOnClosing(done:Boolean) {
        immortalCoroutineScope.launch {
            val editingHost = editingHost.value
            val hostList = hostList
            if (!editingHost.isNullOrBlank() && !hasHost(editingHost)) {
                if (!confirm(R.string.confirm_close_on_editing_host)) {
                    return@launch
                }
            }
            if (done && hostList.isNullOrEmpty()) {
                if (!confirm(R.string.confirm_close_with_no_host)) {
                    return@launch
                }
            }
            result = done
            commandComplete.invoke()
        }
    }

    val settings: Settings
        get() = Settings(
            activeHost = activeHost.value,
            hostList = hostList,
            sourceType = sourceType.value ?: SourceType.DB,
            rating = rating.value ?: Rating.NORMAL,
            theme = theme.value ?: ThemeSetting.SYSTEM,
            colorVariation = colorVariation.value ?: ColorVariation.PINK,
            marks = markList.value ?: emptyList(),
            category = categoryList.category
        )

    fun load(context: Context) {
        val s = Settings.load(context)
        activeHost.value = s.activeHost ?: ""
        hostList.replace(s.hostList)
        sourceType.value = s.sourceType
        rating.value = s.rating
        theme.value = s.theme
        colorVariation.value = s.colorVariation
        markList.value = s.marks
        categoryList.category = s.category
    }

    fun save(context: Context): Boolean {
        val s = settings
        if (!s.isValid) {
            return false
        }
        s.save(context)
        return true
    }

    companion object {
//        fun instanceFor(activity: ViewModelStoreOwner):SettingViewModel {
//            return ViewModelProvider(activity, ViewModelProvider.NewInstanceFactory()).get(SettingViewModel::class.java)
//        }
        /**
         * 
         */
        fun createBy(task: IUtImmortalTask, initialize: ((SettingViewModel) -> Unit)? = null): SettingViewModel
            = UtImmortalViewModelHelper.createBy(SettingViewModel::class.java, task, initialize)

        /**
         * 
         */
        fun instanceFor(dialog: IUtDialog): SettingViewModel
            = UtImmortalViewModelHelper.instanceFor(SettingViewModel::class.java, dialog)

        fun getString(@StringRes id:Int):String =
            BooApplication.instance.getString(id)

        suspend fun confirm(@StringRes id:Int):Boolean {
            return UtImmortalSimpleTask.runAsync("confirm") {
                showOkCancelMessageBox(getString(R.string.app_name), getString(id))
            }
        }

    }
}
